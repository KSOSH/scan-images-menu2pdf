var date;const fs=require("fs"),path=require("path"),colors=require("colors"),compress_images=require("compress-images"),{spawn:spawn}=require("child_process"),dialog=require("node-file-dialog"),{PDFDocument:PDFDocument}=require("./modules/pdf-lib/pdf-lib.js"),config={type:"directory"};var mapsFiles,filesOne=[{title:"Меню питания для 1-​4 классов",sufix:"-1-4"},{title:"Меню питания для учащихся с ОВЗ",sufix:"-ovz"},{title:"Индивидуальное меню питания",sufix:"-ind"},{title:"Меню питания для школьников",sufix:""},{title:"Меню питания для детей мобилизованных родителей",sufix:"-mob"}],filesTen=[{title:"Примерное двухнедельное меню рациона питания для детей учащихся 1-​4 класса",sufix:"-1-4"},{title:"Примерное двухнедельное меню рациона питания для детей c ОВЗ",sufix:"-ovz"},{title:"Примерное двухнедельное индивидуальное меню рациона питания",sufix:"-ind"},{title:"Примерное двухнедельное меню рациона питания для учащихся",sufix:""},{title:"Примерное двухнедельное меню рациона питания для детей мобилизованных родителей",sufix:"-mob"}],typeMenu=!1;function openExplorerin(e,o){var t="";switch(require("os").platform().toLowerCase().replace(/[0-9]/g,"").replace("darwin","macos")){case"win":e=(e=(e=e||"=").replace(/\//g,"\\")).replace(/\\$/,""),t="explorer";break;case"linux":e=e||"/",t="xdg-open";break;case"macos":e=e||"/",t="open"}let r=require("child_process").spawn(t,[e]);r.on("error",(e=>(r.kill(),o(e))))}function isDir(e){return new Promise((function(o,t){try{fs.lstatSync(e).isDirectory()?o(!0):o(!1)}catch(e){o(!1)}}))}function readDirectory(e){return new Promise((function(o,t){o(fs.readdirSync(e).filter((function(e){return!!(e.endsWith(".jpg")||e.endsWith(".jpeg")||e.endsWith(".png")||e.endsWith(".JPG")||e.endsWith(".JPEG")||e.endsWith(".PNG"))})))}))}function resize(e,o,t){return new Promise((function(r,i){const n=spawn("magick",["convert",e,"-filter","Catrom","-resize",`${t}x`,"-quality","80",o]);n.stdout.on("data",(e=>{console.log(`stdout: ${e}`)})),n.stderr.on("data",(e=>{console.error(`stderr: ${e}`)})),n.on("close",(e=>{0==e?r(o):i(e)}))}))}function compress(e,o){return new Promise((function(t,r){compress_images(e,o+"png/",{compress_force:!0,statistic:!1,autoupdate:!0},!1,{jpg:{engine:"mozjpeg",command:["-quality","80"]}},{png:{engine:"pngquant",command:["--quality=20-50","-o"]}},{svg:{engine:"svgo",command:"--multipass"}},{gif:{engine:"gifsicle",command:["--colors","64","--use-col=web"]}},(function(e,o){e?r(e):o&&t(o)}))}))}function pdfGenerator(e,o){return new Promise((async function(t,r){await isDir(e)||fs.mkdirSync(e);try{var i=await readDirectory(o);if(i.length){mapsFiles=typeMenu?filesTen:filesOne;let r,n=0,s=typeMenu?11:2,l=0,c=5;for(let t of i){let i=o+t,a=path.extname(t);a=a.toLowerCase();let d,f=await fs.readFileSync(i);0==n&&(console.log("Create PDF object...".bold.cyan),r=await PDFDocument.create()),".jpg"==a||".jpeg"==a?d=await r.embedJpg(f):".png"==a&&(d=await r.embedPng(f));let p=d.scale(.7);if(r.addPage([p.width,p.height]).drawImage(d,{x:0,y:0,width:p.width,height:p.height}),++n,n==s){r.setAuthor("ГБОУ СОШ пос. Комсомольский"),r.setCreator("ГБОУ СОШ пос. Комсомольский"),r.setProducer("ГБОУ СОШ пос. Комсомольский");let o=date.getDate(),t=date.getMonth()+1,i=date.getFullYear(),s=o<10?`0${o}`:o;t=t<10?`0${t}`:t;let a=`${s}.${t}.${i}`,d=await isDir(e+a+"/");console.log(e+a+"/"),d||fs.mkdirSync(e+a+"/"),r.setTitle(mapsFiles[l].title+" на "+a),r.setKeywords([mapsFiles[l].title+" на "+a]),r.setSubject(mapsFiles[l].title+" на "+a),r.setCreationDate(new Date),r.setModificationDate(new Date);let f=await r.save(),p=`${a}${mapsFiles[l].sufix}.pdf`;fs.writeFileSync(e+a+"/"+p,f),console.log(String("Write file:").bold.cyan+" "+p+" DONE!".bold.yellow),++l,l==c&&(day=date.getDay(),5==day?day=3:day=1,l=0,date.setDate(o+day)),n=0}}openExplorerin(e,(function(){})),t(String("Done create pdf`s files!").bold.yellow)}else r(String("Empty directory:").bold.red+" "+o)}catch(e){r(e)}}))}function promptDialog(e){return new Promise((function(o,t){let r=require("prompt"),i=e?{properties:{date:{pattern:/\d{1,2}$/,message:"Тип меню. 1 - каждодневное, 2 - двухнедельное",description:"Тип меню. 1 - каждодневное, 2 - двухнедельное",type:"string",required:!0}}}:{properties:{date:{pattern:/\d{4}-\d{2}-\d{2}$/,message:"Введите дату. Формат записи даты yyyy-mm-dd",description:"Введите дату. Формат записи даты yyyy-mm-dd",type:"string",required:!0}}};r.start(),r.get(i,(function(e,r){null==e?o(r.date):t(e)}))}))}promptDialog(0).then((function(e){let o=(date=new Date(e)).getDay();o=6==o?2:0==o?1:0,date.setDate(date.getDate()+o),console.log(date.toString().cyan.bold),promptDialog(1).then((function(e){typeMenu=1!=e,dialog(config).then((async function(e){let o=e[0].replace(/\\/g,"/")+"/";await isDir(o)&&readDirectory(o).then((async function(e){await isDir(`${o}pdf`)&&(console.log("Delete directory pdf".bold.yellow),fs.rmSync(`${o}pdf`,{recursive:!0,force:!0}));let t=`${o}resize/`;await isDir(t)||fs.mkdirSync(t);for(let r of e){let e=`${o}${r}`,i=`${t}${r}`;console.log("    Read iamge:".cyan.bold+` ${e} `),await resize(e,i,typeMenu?1604:1134),console.log("Resizeed image:".bold.cyan+` ${i} `+"DONE!".bold.yellow)}const r=`${o}resize/*.{jpg,png,jpeg,JPG,PNG,JPEG}`;console.log("Start compressed images...".bold.yellow),compress(r,o).then((function(e){console.log("Compressed images DONE!".bold.yellow),pdfGenerator(o+"pdf/",o+"png/").then((function(e){console.log(e),fs.rmSync(`${o}resize`,{recursive:!0,force:!0}),fs.rmSync(`${o}png`,{recursive:!0,force:!0}),console.log("Delete directory`s resize && png".bold.yellow)})).catch((function(e){console.log("PDF Error!".bold.red),console.log(e),fs.rmSync(`${o}resize`,{recursive:!0,force:!0}),fs.rmSync(`${o}png`,{recursive:!0,force:!0}),console.log("Delete directory`s resize && png".bold.yellow)}))})).catch((function(e){console.log("Compress Error!".bold.red),console.log(e),fs.rmSync(`${o}resize`,{recursive:!0,force:!0}),fs.rmSync(`${o}png`,{recursive:!0,force:!0}),console.log("Delete directory`s resize && png".bold.yellow)}))})).catch((function(){console.log(`Error: ${o}`.bold.red),fs.rmSync(`${o}resize`,{recursive:!0,force:!0}),fs.rmSync(`${o}png`,{recursive:!0,force:!0}),console.log("Delete directory`s resize && png".bold.yellow)}))})).catch((function(e){console.log(e),fs.rmSync(`${dir}resize`,{recursive:!0,force:!0}),fs.rmSync(`${dir}png`,{recursive:!0,force:!0}),console.log("Delete directory`s resize && png".bold.yellow)}))}))}));
