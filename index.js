const a=require('fs'),c=require('path'),d=require('compress-images'),{spawn:e}=require('child_process'),{PDFDocument:f}=require('./modules/pdf-lib/pdf-lib.js'),g=require('./modules/dialogs/dialogs.js'),h=function(){var _a;const _c=a.readFileSync('menu.json'),_d=JSON.parse(_c),_e=function(_temp){console.log(_temp)};let _f,_g,_h=[],i='',j=!1,k;for(let _temp2 of _d)_temp2["name"]&&_h.push({"name":_temp2["name"]});const l=function(_temp3,_temp4){var _temp5=``;switch(require(`os`).platform().toLowerCase().replace(/\d/g,``).replace(`darwin`,`macos`)) {case `win`:_temp3=_temp3||'=';_temp3=_temp3.replace(/\//g,`\\`);_temp3=_temp3.replace(/\\$/,``);_temp5=`explorer`;break;case `linux`:_temp3=_temp3||'/';_temp5=`xdg-open`;break;case `macos`:_temp3=_temp3||'/';_temp5=`open`;break}let p=require(`child_process`).spawn(_temp5,[_temp3]);p.on('error',(_temp6)=>{p.kill();return _temp4(_temp6)})},m=function(_temp7){return new Promise(function(_i){try {let _temp8=a.lstatSync(_temp7);_temp8.isDirectory()?_i(!0):_i(!1)} catch {_i(!1)}})},n=function(_j){return new Promise(function(_temp9){let _k=a.readdirSync(_j).filter((_temp10)=>{if(_temp10.endsWith('.jpg')||_temp10.endsWith('.jpeg')||_temp10.endsWith('.png')||_temp10.endsWith('.JPG')||_temp10.endsWith('.JPEG')||_temp10.endsWith('.PNG'))return !0;return !1});_temp9(_k)})},o=function(_l,_m,_n){return new Promise(function(_temp11,_temp12){let _temp13=["convert", _l, "-filter", "Catrom", "-resize", `${_n}x`, "-quality", "80", _m];var _o=e('magick',_temp13);_o.stdout.on('data',(data)=>_e(`stdout: ${data}`));_o.stderr.on('data',(data)=>_e(`stderr: ${data}`));_o.on('close',(_temp14)=>!_temp14?_temp11(_m):_temp12(_temp14))})},p=function(m,d){return new Promise(function(_p,_q){d(m,`${d}png/`,{compress_force:!0,statistic:!1,autoupdate:!0},!1,{jpg:{engine:"mozjpeg",command:["-quality","80"]}},{png:{engine:"pngquant",command:["--quality=20-50","-o"]}},{svg:{engine:"svgo",command:"--multipass"}},{gif:{engine:"gifsicle",command:["--colors","64","--use-col=web"]}},function(_temp15,_temp16,r){_e(`Чтение изображения:`.cyan.bold+` ${r.input} `);if(!_temp15){_e(`Сжатие изображения:`.bold.cyan+` ${r.path_out_new} `+`УСПЕШНО!`.bold.yellow);_temp16&&_p(_temp16)}else _q(_temp15)})})},q=function(r,s){return new Promise(async function(_r,_s){let t=await m(r);!t&&a.mkdirSync(r);try {var u=await n(s);if(u.length){k=_d[j]["items"];let i=0;let c=_d[j]["files"];var _temp17=_d[j]["format"];let k=0;let f=k.length;let _temp18;for(let _t of u){let _temp19=s+_t;let _u=c.extname(_t);_u=_u.toLowerCase();let v=await a.readFileSync(_temp19);!i&&(_e('Создаём PDF документ...'.bold.cyan),_temp18=await f.create());let w;_u==='.jpg'||_u==='.jpeg'?w=await _temp18.embedJpg(v):_u==='.png'&&(w=await _temp18.embedPng(v));let x=w.scale(0.7);let y=_temp18.addPage([x.width,x.height]);y.drawImage(w,{x:0,y:0,width:x.width,height:x.height});++i;if(i===c){_temp18.setAuthor(_d[j]["author"]);_temp18.setProducer(_d[j]["produser"]);_temp18.setCreator("https://github.com/Hopding/pdf-lib https://github.com/KSOSH/scan-images-menu2pdf");let d=_a.getDate();let m=_a.getMonth()+1;let y=_a.getFullYear();let _temp20=d<10?`0${d}`:d;m=m<10?`0${m}`:m;let _v=`${_temp20}.${m}.${y}`;let _w=_temp17.replace("%d",_temp20).replace("%m",m).replace("%y",y);let _x=await m(`${r}${_v}/`);!_x&&_d[j]["multidir"]&&(a.mkdirSync(`${r}${_v}/`),_e('Директория создана:'.bold.cyan+" "+`${r}${_v}/`.bold.yellow));_temp18.setTitle(k[k].title+" на "+_v);_temp18.setKeywords([k[k].title+" на "+_v]);_temp18.setSubject(k[k].title+" на "+_v);_temp18.setCreationDate(new Date());_temp18.setModificationDate(new Date());let _y=await _temp18.save();let z=`${_w}${k[k].sufix}.pdf`;_v=!_d[j]["multidir"]?``:`${_v}/`;_e(`${r}${_v}${z}`);a.writeFileSync(`${r}${_v}${z}`,_y);_e(''+'     Запись в файл:'.bold.cyan+" "+z+" УСПЕШНО!".bold.yellow);++k;k===f&&(day=_a.getDay(),day===5?day=3:day=1,k=0,_a.setDate(d+day));i=0}}l(r,function(){});_r(''+"\nВсе PDF файлы созданы!\n".bold.yellow)}else _s(''+"Директория пустая:".bold.red+" "+s)} catch (e) {_s(e)}})};g(_h).then(async function(v){v=JSON.parse(v);if(parseInt(v.typemenu)>-1&&v.directory!=="None"&&v.data.length){j=parseInt(v.typemenu);i=v.directory+'/';_a=new Date(v.data);let _v=_a.getDay();_v===6?_v=2:!_v?_v=1:_v=0;_a.setDate(_a.getDate()+_v);let w=await m(i);w&&n(i).then(async function(_temp21){_f=new Date().getTime();if(await m(`${i}pdf`)){_e("Удаляем директорию с PDF файлами".bold.yellow);a.rmSync(`${i}pdf`,{recursive:!0,force:!0})}let _w=`${i}resize/`,x=await m(_w);if(!x)a.mkdirSync(_w);let y;switch(_d[j]["size"]) {case 'portrait':y=1130;break;case 'landscape':y=1600;break;default:y=1130}for(let _temp22 of _temp21){let _x=`${i}${_temp22}`,_y=`${_w}${_temp22}`;_e(`Чтение изображения:`.cyan.bold+` ${_x} `);await o(_x,_y,y);_e(`Ресайз изображения:`.bold.cyan+` ${_y} `+`УСПЕШНО!`.bold.yellow)}var z=`${i}resize/*.{jpg,png,jpeg,JPG,PNG,JPEG}`;_e("Старт оптимизации изображений...".bold.yellow);p(z,i).then(()=>{_e("Все изображения оптимизированы!".bold.yellow);let _x=`${i}pdf/`,_y=`${i}png/`;q(_x,_y).then((_temp23)=>{_e(_temp23);_e("Удаление директорий с оптимизированными изображениями...".bold.yellow);a.rmSync(`${i}resize`,{recursive:!0,force:!0});a.rmSync(`${i}png`,{recursive:!0,force:!0});_g=new Date().getTime();let _temp24=_g-_f;_temp24=parseFloat(_temp24/1000).toFixed(2);_e(" ");_e("Затраченное время в секундах:".bold.yellow+' '+_temp24+"s");_e(" ")}).catch((_z)=>{_e("Ошибка при генерации PDF!".bold.red);_e(_z);a.rmSync(`${i}resize`,{recursive:!0,force:!0});a.rmSync(`${i}png`,{recursive:!0,force:!0});_e("Удаление директорий с оптимизированными изображениями...".bold.yellow);_e(" ")})}).catch((_z)=>{_e("Ошибка оптимизации изображений!".bold.red);_e(_z);_e("Удаление директорий с оптимизированными изображениями...".bold.yellow);a.rmSync(`${i}resize`,{recursive:!0,force:!0});a.rmSync(`${i}png`,{recursive:!0,force:!0});_e(" ")})}).catch((z)=>{_e(`Ошибка!: ${i}`.bold.red);_e(z);_e("Удаление директорий с оптимизированными изображениями...".bold.yellow);a.rmSync(`${i}resize`,{recursive:!0,force:!0});a.rmSync(`${i}png`,{recursive:!0,force:!0});_e(" ")})}else _e("Завершено пользователем".bold.yellow)}).catch((z)=>{_e(`Ошибка!`.bold.red);_e(z);_e(" ")})};h();
