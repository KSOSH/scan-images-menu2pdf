const fs=require("fs"),path=require("path"),colors=require("colors"),compress_images=require("compress-images"),{spawn:spawn,exec:exec}=require("child_process"),{PDFDocument:PDFDocument}=require("./modules/pdf-lib/pdf-lib.js"),dialogs=require("./modules/dialogs/dialogs.js"),start=function(){var e;const t=fs.readFileSync("menu.json"),n=JSON.parse(t),r=function(e){console.log(e)};let o,a,i,s=[],c="",l=!1;for(let e of n)e.name&&s.push({name:e.name});const d=function(e){return new Promise((function(t,n){try{fs.lstatSync(e).isDirectory()?t(!0):t(!1)}catch(e){t(!1)}}))},u=function(e){return new Promise((function(t,n){t(fs.readdirSync(e).filter((function(e){return!!(e.endsWith(".jpg")||e.endsWith(".jpeg")||e.endsWith(".png")||e.endsWith(".JPG")||e.endsWith(".JPEG")||e.endsWith(".PNG"))})))}))},f=function(e,t,n){return new Promise((function(o,a){const i=spawn("magick",["convert",e,"-filter","Catrom","-resize",`${n}x`,"-quality","80",t]);i.stdout.on("data",(e=>{r(`stdout: ${e}`)})),i.stderr.on("data",(e=>{r(`stderr: ${e}`)})),i.on("close",(e=>{0==e?o(t):a(e)}))}))},p=function(t,o){return new Promise((async function(a,s){await d(t)||fs.mkdirSync(t);try{var c=await u(o);if(c.length){i=n[l].items;let s=0,u=n[l].files;const f=n[l].format;let p,m=0,g=i.length;for(let a of c){let c=o+a,y=path.extname(a);y=y.toLowerCase();let w,$=await fs.readFileSync(c);0==s&&(r("Создаём PDF документ...".bold.cyan),p=await PDFDocument.create()),".jpg"==y||".jpeg"==y?w=await p.embedJpg($):".png"==y&&(w=await p.embedPng($));let h=w.scale(.7);if(p.addPage([h.width,h.height]).drawImage(w,{x:0,y:0,width:h.width,height:h.height}),++s,s==u){p.setAuthor(n[l].author),p.setProducer(n[l].produser),p.setCreator("https://github.com/Hopding/pdf-lib https://github.com/KSOSH/scan-images-menu2pdf");let o=e.getDate(),a=e.getMonth()+1,c=e.getFullYear(),u=o<10?`0${o}`:o;a=a<10?`0${a}`:a;let y=`${u}.${a}.${c}`,w=f.replace("%d",u).replace("%m",a).replace("%y",c);!await d(`${t}${y}/`)&&n[l].multidir&&(fs.mkdirSync(`${t}${y}/`),r("Директория создана:".bold.cyan+" "+`${t}${y}/`.bold.yellow)),p.setTitle(i[m].title+" на "+y),p.setKeywords([i[m].title+" на "+y]),p.setSubject(i[m].title+" на "+y),p.setCreationDate(new Date),p.setModificationDate(new Date);let $=await p.save(),h=`${w}${i[m].sufix}.pdf`;y=n[l].multidir?`${y}/`:"",r(`${t}${y}${h}`),fs.writeFileSync(`${t}${y}${h}`,$),r(String("     Запись в файл:").bold.cyan+" "+h+" УСПЕШНО!".bold.yellow),++m,m==g&&(day=e.getDay(),5==day?day=3:day=1,m=0,e.setDate(o+day)),s=0}}!function(e,t){var n="";switch(require("os").platform().toLowerCase().replace(/[0-9]/g,"").replace("darwin","macos")){case"win":e=(e=(e=e||"=").replace(/\//g,"\\")).replace(/\\$/,""),n="explorer";break;case"linux":e=e||"/",n="xdg-open";break;case"macos":e=e||"/",n="open"}let r=require("child_process").spawn(n,[e]);r.on("error",(e=>(r.kill(),t(e))))}(t,(function(){})),a(String("\nВсе PDF файлы созданы!\n").bold.yellow)}else s(String("Директория пустая:").bold.red+" "+o)}catch(e){s(e)}}))};dialogs(s).then((async function(t){if(t=JSON.parse(t),parseInt(t.typemenu)>-1&&"None"!=t.directory&&t.data.length){l=parseInt(t.typemenu),c=t.directory+"/";let i=(e=new Date(t.data)).getDay();i=6==i?2:0==i?1:0,e.setDate(e.getDate()+i),await d(c)&&u(c).then((async function(e){o=(new Date).getTime(),await d(`${c}pdf`)&&(r("Удаляем директорию с PDF файлами".bold.yellow),fs.rmSync(`${c}pdf`,{recursive:!0,force:!0}));let t,i=`${c}resize/`;switch(await d(i)||fs.mkdirSync(i),n[l].size){case"portrait":default:t=1130;break;case"landscape":t=1600}for(let n of e){let e=`${c}${n}`,o=`${i}${n}`;r("Чтение изображения:".cyan.bold+` ${e} `),await f(e,o,t),r("Ресайз изображения:".bold.cyan+` ${o} `+"УСПЕШНО!".bold.yellow)}const s=`${c}resize/*.{jpg,png,jpeg,JPG,PNG,JPEG}`;var u,m;r("Старт оптимизации изображений...".bold.yellow),(u=s,m=c,new Promise((function(e,t){compress_images(u,m+"png/",{compress_force:!0,statistic:!1,autoupdate:!0},!1,{jpg:{engine:"mozjpeg",command:["-quality","80"]}},{png:{engine:"pngquant",command:["--quality=20-50","-o"]}},{svg:{engine:"svgo",command:"--multipass"}},{gif:{engine:"gifsicle",command:["--colors","64","--use-col=web"]}},(function(n,o,a){r("Чтение изображения:".cyan.bold+` ${a.input} `),n?t(n):(r("Сжатие изображения:".bold.cyan+` ${a.path_out_new} `+"УСПЕШНО!".bold.yellow),o&&e(o))}))}))).then((function(e){r("Все изображения оптимизированы!".bold.yellow),p(c+"pdf/",c+"png/").then((function(e){r(e),r("Удаление директорий с оптимизированными изображениями...".bold.yellow),fs.rmSync(`${c}resize`,{recursive:!0,force:!0}),fs.rmSync(`${c}png`,{recursive:!0,force:!0}),a=(new Date).getTime();let t=a-o;t=parseFloat(t/1e3).toFixed(2),r(" "),r("Затраченное время в секундах:".bold.yellow+" "+t+"s"),r(" ")})).catch((function(e){r("Ошибка при генерации PDF!".bold.red),r(e),fs.rmSync(`${c}resize`,{recursive:!0,force:!0}),fs.rmSync(`${c}png`,{recursive:!0,force:!0}),r("Удаление директорий с оптимизированными изображениями...".bold.yellow),r(" ")}))})).catch((function(e){r("Ошибка оптимизации изображений!".bold.red),r(e),r("Удаление директорий с оптимизированными изображениями...".bold.yellow),fs.rmSync(`${c}resize`,{recursive:!0,force:!0}),fs.rmSync(`${c}png`,{recursive:!0,force:!0}),r(" ")}))})).catch((function(e){r(`Ошибка!: ${c}`.bold.red),r(e),r("Удаление директорий с оптимизированными изображениями...".bold.yellow),fs.rmSync(`${c}resize`,{recursive:!0,force:!0}),fs.rmSync(`${c}png`,{recursive:!0,force:!0}),r(" ")}))}else r("Завершено пользователем".bold.yellow)})).catch((e=>{r("Ошибка!".bold.red),r(e),r(" ")}))};start();
