var date;const fs=require("fs"),path=require("path"),colors=require("colors"),compress_images=require("compress-images"),{spawn:spawn,exec:exec}=require("child_process"),{PDFDocument:PDFDocument}=require("./modules/pdf-lib/pdf-lib.js"),dialogs=require("./modules/dialogs/dialogs.js"),json=fs.readFileSync("menu.json"),jsonPars=JSON.parse(json),log=function(e){console.log(e)};let startTime,endTime,mapsFiles,jsonType=[],dir="",typeMenu=!1;for(let e of jsonPars)jsonType.push({name:e.name});function openExplorerin(e,r){var t="";switch(require("os").platform().toLowerCase().replace(/[0-9]/g,"").replace("darwin","macos")){case"win":e=(e=(e=e||"=").replace(/\//g,"\\")).replace(/\\$/,""),t="explorer";break;case"linux":e=e||"/",t="xdg-open";break;case"macos":e=e||"/",t="open"}let o=require("child_process").spawn(t,[e]);o.on("error",(e=>(o.kill(),r(e))))}function isDir(e){return new Promise((function(r,t){try{fs.lstatSync(e).isDirectory()?r(!0):r(!1)}catch(e){r(!1)}}))}function readDirectory(e){return new Promise((function(r,t){r(fs.readdirSync(e).filter((function(e){return!!(e.endsWith(".jpg")||e.endsWith(".jpeg")||e.endsWith(".png")||e.endsWith(".JPG")||e.endsWith(".JPEG")||e.endsWith(".PNG"))})))}))}function resize(e,r,t){return new Promise((function(o,i){const n=spawn("magick",["convert",e,"-filter","Catrom","-resize",`${t}x`,"-quality","80",r]);n.stdout.on("data",(e=>{log(`stdout: ${e}`)})),n.stderr.on("data",(e=>{log(`stderr: ${e}`)})),n.on("close",(e=>{0==e?o(r):i(e)}))}))}function compress(e,r){return new Promise((function(t,o){compress_images(e,r+"png/",{compress_force:!0,statistic:!1,autoupdate:!0},!1,{jpg:{engine:"mozjpeg",command:["-quality","80"]}},{png:{engine:"pngquant",command:["--quality=20-50","-o"]}},{svg:{engine:"svgo",command:"--multipass"}},{gif:{engine:"gifsicle",command:["--colors","64","--use-col=web"]}},(function(e,r,i){log("Чтение изображения:".cyan.bold+` ${i.input} `),e?o(e):(log("Сжатие изображения:".bold.cyan+` ${i.path_out_new} `+"УСПЕШНО!".bold.yellow),r&&t(r))}))}))}function pdfGenerator(e,r){return new Promise((async function(t,o){await isDir(e)||fs.mkdirSync(e);try{var i=await readDirectory(r);if(i.length){mapsFiles=jsonPars[typeMenu].items;let o=0,n=jsonPars[typeMenu].files;const s=jsonPars[typeMenu].format;let a,l=0,c=mapsFiles.length;for(let t of i){let i=r+t,d=path.extname(t);d=d.toLowerCase();let g,p=await fs.readFileSync(i);0==o&&(log("Создаём PDF документ...".bold.cyan),a=await PDFDocument.create()),".jpg"==d||".jpeg"==d?g=await a.embedJpg(p):".png"==d&&(g=await a.embedPng(p));let u=g.scale(.7);if(a.addPage([u.width,u.height]).drawImage(g,{x:0,y:0,width:u.width,height:u.height}),++o,o==n){a.setAuthor(jsonPars[typeMenu].author),a.setProducer(jsonPars[typeMenu].produser),a.setCreator("https://github.com/Hopding/pdf-lib https://github.com/KSOSH/scan-images-menu2pdf");let r=date.getDate(),t=date.getMonth()+1,i=date.getFullYear(),n=r<10?`0${r}`:r;t=t<10?`0${t}`:t;let d=`${n}.${t}.${i}`,g=s.replace("%d",n).replace("%m",t).replace("%y",i);!await isDir(`${e}${d}/`)&&jsonPars[typeMenu].multidir&&(fs.mkdirSync(`${e}${d}/`),log("Директория создана:".bold.cyan+" "+`${e}${d}/`.bold.yellow)),a.setTitle(mapsFiles[l].title+" на "+d),a.setKeywords([mapsFiles[l].title+" на "+d]),a.setSubject(mapsFiles[l].title+" на "+d),a.setCreationDate(new Date),a.setModificationDate(new Date);let p=await a.save(),u=`${g}${mapsFiles[l].sufix}.pdf`;d=jsonPars[typeMenu].multidir?`${d}/`:"",log(`${e}${d}${u}`),fs.writeFileSync(`${e}${d}${u}`,p),log(String("     Запись в файл:").bold.cyan+" "+u+" УСПЕШНО!".bold.yellow),++l,l==c&&(day=date.getDay(),5==day?day=3:day=1,l=0,date.setDate(r+day)),o=0}}openExplorerin(e,(function(){})),t(String("\nВсе PDF файлы созданы!\n").bold.yellow)}else o(String("Директория пустая:").bold.red+" "+r)}catch(e){o(e)}}))}dialogs(jsonType).then((async function(e){if(e=JSON.parse(e),parseInt(e.typemenu)>-1&&"None"!=e.directory&&e.data.length){typeMenu=parseInt(e.typemenu),dir=e.directory+"/";let r=(date=new Date(e.data)).getDay();r=6==r?2:0==r?1:0,date.setDate(date.getDate()+r),await isDir(dir)&&readDirectory(dir).then((async function(e){startTime=(new Date).getTime(),await isDir(`${dir}pdf`)&&(log("Удаляем директорию с PDF файлами".bold.yellow),fs.rmSync(`${dir}pdf`,{recursive:!0,force:!0}));let r,t=`${dir}resize/`;switch(await isDir(t)||fs.mkdirSync(t),jsonPars[typeMenu].size){case"portrait":default:r=1130;break;case"landscape":r=1600}for(let o of e){let e=`${dir}${o}`,i=`${t}${o}`;log("Чтение изображения:".cyan.bold+` ${e} `),await resize(e,i,r),log("Ресайз изображения:".bold.cyan+` ${i} `+"УСПЕШНО!".bold.yellow)}const o=`${dir}resize/*.{jpg,png,jpeg,JPG,PNG,JPEG}`;log("Старт оптимизации изображений...".bold.yellow),compress(o,dir).then((function(e){log("Все изображения оптимизированы!".bold.yellow),pdfGenerator(dir+"pdf/",dir+"png/").then((function(e){log(e),log("Удаление директорий с оптимизированными изображениями...".bold.yellow),fs.rmSync(`${dir}resize`,{recursive:!0,force:!0}),fs.rmSync(`${dir}png`,{recursive:!0,force:!0}),endTime=(new Date).getTime();let r=endTime-startTime;r=parseFloat(r/1e3).toFixed(2),log(" "),log("Затраченное время в секундах:".bold.yellow+" "+r+"s"),log(" ")})).catch((function(e){log("Ошибка при генерации PDF!".bold.red),log(e),fs.rmSync(`${dir}resize`,{recursive:!0,force:!0}),fs.rmSync(`${dir}png`,{recursive:!0,force:!0}),log("Удаление директорий с оптимизированными изображениями...".bold.yellow),log(" ")}))})).catch((function(e){log("Ошибка оптимизации изображений!".bold.red),log(e),log("Удаление директорий с оптимизированными изображениями...".bold.yellow),fs.rmSync(`${dir}resize`,{recursive:!0,force:!0}),fs.rmSync(`${dir}png`,{recursive:!0,force:!0}),log(" ")}))})).catch((function(e){log(`Ошибка!: ${dir}`.bold.red),log(e),log("Удаление директорий с оптимизированными изображениями...".bold.yellow),fs.rmSync(`${dir}resize`,{recursive:!0,force:!0}),fs.rmSync(`${dir}png`,{recursive:!0,force:!0}),log(" ")}))}else log("Завершено пользователем".bold.yellow)})).catch((e=>{log("Ошибка!".bold.red),log(e),log(" ")}));
